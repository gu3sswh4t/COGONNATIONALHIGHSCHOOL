<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FILE DEPOT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@500;700;800&family=Kalam:wght@400;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --secondary: #0ea5e9;
            --accent: #8b5cf6;
            --bg-body: #f3f4f6;
            --glass-surface: rgba(255, 255, 255, 0.65);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --font-head: 'Outfit', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-body);
            color: var(--text-main);
            margin: 0;
            min-height: 100vh;
            display: flex; flex-direction: column;
            overflow-x: hidden;
            background-color: #e0e7ff;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background: 
                radial-gradient(at 0% 0%, rgba(79, 70, 229, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(14, 165, 233, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.15) 0px, transparent 50%),
                #f8fafc;
            background-attachment: fixed;
        }

        h1, h2, h3, h4 { font-family: var(--font-head); margin: 0; color: #111827; letter-spacing: -0.5px; }
        
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 10px 20px; border-radius: var(--radius-sm); border: none;
            font-weight: 500; cursor: pointer; transition: all 0.2s ease;
            font-family: var(--font-body); font-size: 0.95rem; text-decoration: none;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .btn-primary:hover { box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4); transform: translateY(-1px); }
        .btn-secondary { background: white; border: 1px solid #e5e7eb; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }
        .btn-danger { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
        .btn-danger:hover { background: #ef4444; color: white; }
        .btn-warning { background: #ffedd5; color: #c2410c; border: 1px solid #fed7aa; font-size: 0.8em; padding: 5px 10px; }
        .btn-warning:hover { background: #fed7aa; }
        .btn-icon { padding: 8px; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: transparent; border: none; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .btn-icon:hover { background: rgba(0,0,0,0.05); color: var(--primary); }
        
        .btn-install { 
            background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; 
            padding: 8px 16px; border-radius: 50px; font-size: 0.85rem; display: none;
        }
        .btn-install:hover { background: #bfdbfe; }

        .btn-back {
            display: inline-flex; align-items: center; gap: 8px;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(4px);
            padding: 8px 16px; border-radius: 50px; border: 1px solid rgba(0,0,0,0.1);
            color: var(--text-main); font-weight: 600; cursor: pointer;
            transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-right: 15px; text-decoration: none; font-size: 0.9rem;
        }
        .btn-back:hover { transform: translateX(-3px); border-color: var(--primary); color: var(--primary); background: white; }
        .btn-back svg { width: 18px; height: 18px; }

        .input-group { position: relative; width: 100%; margin-bottom: 15px; }
        input, select, textarea {
            width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.8);
            border: 1px solid #e5e7eb; border-radius: var(--radius-sm);
            color: var(--text-main); font-family: var(--font-body); font-size: 1rem;
            transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); background: white; }
        .password-toggle { position: absolute; right: 12px; top: 14px; cursor: pointer; color: var(--text-muted); padding: 5px; z-index: 10; }

        .card {
            background: var(--glass-surface); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: var(--glass-border); border-radius: var(--radius-md);
            padding: 30px; margin-bottom: 25px; box-shadow: var(--glass-shadow);
        }

        .tabs { display: flex; gap: 5px; margin-bottom: 20px; background: rgba(0,0,0,0.03); padding: 5px; border-radius: var(--radius-sm); }
        .tab-btn { flex: 1; border: none; background: transparent; color: var(--text-muted); padding: 10px; border-radius: 6px; font-weight: 500; cursor: pointer;}
        .tab-btn:hover { color: var(--text-main); background: rgba(255,255,255,0.5); }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .header {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05); padding: 10px 3%;
            display: flex; justify-content: space-between; align-items: center;
        }
        .nav-desktop ul { display: flex; gap: 5px; list-style: none; margin: 0; padding: 0; align-items: center; }
        .nav-item { position: relative; }
        .nav-link { 
            color: var(--text-muted); text-decoration: none; font-weight: 500; font-size: 0.95rem;
            padding: 10px 18px; border-radius: 50px; transition: 0.2s; display: flex; align-items: center; gap: 5px; cursor: pointer; user-select: none;
        }
        .nav-link:hover { color: var(--primary); background: rgba(79, 70, 229, 0.05); }
        
        .dropdown-menu {
            position: absolute; top: 120%; left: 0; 
            background: white; border: 1px solid #f3f4f6;
            border-radius: var(--radius-sm); padding: 6px; min-width: 240px;
            opacity: 0; visibility: hidden; transform: translateY(10px);
            transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            z-index: 2000; max-height: 400px; overflow-y: auto;
        }
        .nav-item.active .dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); top: 110%; }
        .dropdown-link { display: block; padding: 12px 16px; color: var(--text-muted); text-decoration: none; font-size: 0.95rem; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .dropdown-link:hover { background: #eff6ff; color: var(--primary); }
        
        .header-actions { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; justify-content: flex-end; }
        
        .school-name { 
            font-weight: 800; 
            color: #111827; 
            font-family: var(--font-head); 
            letter-spacing: -0.5px; 
            text-transform: uppercase; 
            font-size: 1.5rem;
            text-align: right;
            line-height: 1.1;
        }
        
        #welcomeBar {
            display: none;
            padding: 10px 3%;
            max-width: 1400px;
            margin: 0 auto;
            font-family: var(--font-body);
            color: var(--text-muted);
            font-size: 1rem;
            align-items: center;
            gap: 5px;
        }
        #welcomeBar span { color: var(--primary); font-weight: 700; }

        #achievementBanner {
            background: linear-gradient(90deg, #4f46e5, #8b5cf6);
            height: 36px; display: none; align-items: center; justify-content: center;
            color: white; font-weight: 500; font-size: 0.85rem; letter-spacing: 0.5px;
        }

        main { max-width: 1400px; margin: 0 auto; padding: 40px 3%; width: 100%; position: relative; z-index: 1; flex: 1; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .section-title { font-size: 1.75rem; font-weight: 700; color: #111827; display: flex; align-items: center; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

        .landing-hero { min-height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 40px 20px; }
        .hero-title {
            font-size: clamp(3rem, 5vw, 5rem); font-weight: 800; line-height: 1.1; margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        .table-container { overflow-x: auto; background: white; border-radius: var(--radius-sm); border: 1px solid #e5e7eb; }
        .table { width: 100%; border-collapse: collapse; text-align: left; }
        .table th { background: #f9fafb; color: #6b7280; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; padding: 16px; border-bottom: 1px solid #e5e7eb; }
        .table td { padding: 16px; border-bottom: 1px solid #f3f4f6; color: #374151; font-size: 0.95rem; }
        .table tr:hover td { background: #f9fafb; }
        
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e5e7eb; transition: .3s; border-radius: 30px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        .stat-card { background: white; padding: 25px; border-radius: var(--radius-sm); border: 1px solid #e5e7eb; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: transform 0.2s; cursor:pointer;}
        .stat-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .stat-number { font-size: 2.5rem; font-weight: 800; color: #111827; margin-bottom: 5px; }

        #loader { position: fixed; inset: 0; background: #f3f4f6; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(79, 70, 229, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .toast { padding: 12px 24px; background: white; border-radius: 12px; color: #1f2937; font-weight: 500; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; z-index: 10001; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease; border: 1px solid #e5e7eb; }
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        #toastContainer { position: fixed; bottom: 30px; right: 30px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal { position: fixed; inset: 0; z-index: 3000; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .modal.active { display: flex; opacity: 1; }
        
        .modal-content.pinned-paper {
            width: 95%; max-width: 650px; max-height: 90vh; overflow-y: auto; background: #fdfbf7; border-radius: 2px; padding: 50px 40px 40px 40px; position: relative; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); border: none;
        }
        .modal.active .modal-content.pinned-paper { transform: scale(1) rotate(-1deg); }
        .modal-content.pinned-paper::after { content: ''; position: absolute; top: 15px; left: 50%; transform: translateX(-50%); width: 20px; height: 20px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #ff6b6b, #c0392b); box-shadow: 2px 2px 5px rgba(0,0,0,0.3); z-index: 10; }

        .close-modal { position: absolute; top: 15px; right: 15px; background: transparent; border: none; color: #95a5a6; cursor: pointer; font-size: 1.5rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: 0.2s; z-index: 20; }
        .close-modal:hover { color: #c0392b; transform: scale(1.1); }
        
        #contentModalTitle { font-family: var(--font-head); text-align: center; color: #2c3e50; border-bottom: 2px dashed #bdc3c7; padding-bottom: 15px; margin-bottom: 25px; text-transform: uppercase; letter-spacing: 2px; }
        #contentModalBody { font-family: 'Inter', sans-serif; color: #34495e; line-height: 1.8; font-size: 1.05rem; }

        .modal-content.standard { width: 95%; max-width: 500px; background: white; border-radius: var(--radius-lg); padding: 30px; position:relative; }

        .modal-content.modern-files { width: 95%; max-width: 800px; height: 80vh; background: #fff; border-radius: var(--radius-md); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .file-manager-header { padding: 20px; border-bottom: 1px solid #e5e7eb; background: #f9fafb; display: flex; justify-content: space-between; align-items: center; }
        .file-manager-body { flex: 1; overflow-y: auto; padding: 20px; background: #fff; }
        .file-item { display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f3f4f6; transition: 0.2s; border-radius: 8px; }
        .file-item:hover { background: #f3f4f6; }
        .file-icon { font-size: 1.5rem; margin-right: 15px; }
        .file-info { flex: 1; }
        .file-name { font-weight: 500; color: #1f2937; display: block; }
        .file-meta { font-size: 0.8rem; color: #6b7280; display:flex; gap:10px; align-items:center; }
        
        #lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 4000; display: none; align-items: center; justify-content: center; cursor: zoom-out; }
        #lightbox img { max-width: 90%; max-height: 90%; box-shadow: 0 0 50px rgba(0,0,0,0.5); border-radius: 4px; }
        
        .footer { text-align: center; padding: 25px; color: var(--text-muted); font-size: 0.9rem; background: var(--glass-surface); border-top: var(--glass-border); margin-top: auto; backdrop-filter: blur(10px); }

        .type-selector { display: flex; gap: 15px; margin-bottom: 10px; }
        .type-label { display: flex; align-items: center; gap: 5px; font-weight: 500; color: var(--text-muted); cursor: pointer; }
        .type-label input:checked + span { color: var(--primary); font-weight: 700; }
        
        .upload-instruction { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; padding: 10px; border-radius: 6px; font-size: 0.85rem; margin-bottom: 15px; display: flex; gap: 8px; align-items: flex-start; }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge-admin { background: #fee2e2; color: #991b1b; }
        .badge-user { background: #dcfce7; color: #166534; }
        .badge-disabled { background: #374151; color: #f3f4f6; }
        .badge-public { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; font-size:0.7em; padding:3px 8px; border-radius:12px; }
        .download-count { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; color: #6b7280; font-weight: 600; display: inline-flex; align-items: center; gap: 3px; }

        #mainLogo { max-width: 150px; max-height: 150px; margin-bottom: 20px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); animation: floatLogo 4s ease-in-out infinite; }
        @keyframes floatLogo { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }


        .modal-content.danger {
            background: #ffffff; border-radius: 20px; width: 90%; max-width: 400px; padding: 40px 30px; text-align: center; position: relative; overflow: visible; box-shadow: 0 25px 50px -12px rgba(220, 38, 38, 0.25);
        }
        .modal-icon-wrapper {
            width: 80px; height: 80px; background: #fee2e2; color: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin: -60px auto 20px auto; border: 5px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .modal-title { font-size: 1.5rem; font-weight: 800; color: #111827; margin-bottom: 10px; font-family: var(--font-head); }
        .modal-text { color: #6b7280; margin-bottom: 30px; line-height: 1.6; }
        .modal-actions { display: flex; gap: 15px; justify-content: center; }
        .btn-modal-cancel { background: white; border: 1px solid #e5e7eb; color: #374151; padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; flex: 1; }
        .btn-modal-cancel:hover { background: #f9fafb; }
        .btn-modal-delete { background: #ef4444; border: none; color: white; padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; flex: 1; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
        .btn-modal-delete:hover { background: #dc2626; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4); }

        @media (max-width: 768px) {
            .nav-desktop { display: none; }
            .mobile-toggle { display: block; }
            main { padding: 30px 4%; }
            .hero-title { font-size: 2.5rem; }
            .school-name { display: none; }
            .header-actions { justify-content: flex-end; }
        }
        .mobile-toggle { display: none; background: none; border: none; color: #111; cursor: pointer; }
        #mobileNav { position: fixed; inset: 0; background: white; z-index: 150; padding: 30px; display: flex; flex-direction: column; gap: 20px; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow-y: auto; }
        #mobileNav.open { transform: translateX(0); }

        #mobileNav .nav-item { display: block; width: 100%; margin-bottom: 10px; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; }
        #mobileNav .nav-link { justify-content: space-between; width: 100%; background: none; padding: 10px 0; font-size: 1.1rem;}
        #mobileNav .dropdown-menu { 
            position: static; 
            opacity: 1; 
            visibility: visible; 
            transform: none; 
            box-shadow: none; 
            border: none; 
            padding-left: 15px; 
            display: none;
            max-height: none;
            width: 100%;
        }
        #mobileNav .nav-item.active .dropdown-menu { display: block; }
        #mobileNav .btn-install { display: none; width: 100%; text-align: center; margin-top:10px; }
        #mobileNav .btn-install.mobile-visible { display: block; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>
    <div id="toastContainer"></div>
    <div id="lightbox" onclick="this.style.display='none'"><img id="lightboxImg" src="" alt="Zoomed"></div>
    <div id="tsparticles" style="position: fixed; inset: 0; z-index: -1;"></div>

    <header class="header">
        <nav class="nav-desktop">
            <ul>
                <li class="nav-item">
                    <span class="nav-link">Shortcuts <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></span>
                    <div class="dropdown-menu" id="shortcutsDropdown"><span class="dropdown-link" style="opacity:0.6;">Loading...</span></div>
                </li>
                <li class="nav-item">
                    <span class="nav-link">Announcements <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></span>
                    <div class="dropdown-menu">
                        <div class="dropdown-link" data-page-id="calendar_of_activities">Calendar of Activities</div>
                        <div class="dropdown-link" data-page-id="exam_schedules">Exam Schedules</div>
                        <div class="dropdown-link" data-page-id="enrollment_requirements">Enrollment Requirements</div>
                    </div>
                </li>
                <li class="nav-item">
                    <span class="nav-link">About <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></span>
                    <div class="dropdown-menu">
                        <div class="dropdown-link" data-page-id="faculty_and_staff">Faculty & Staff</div>
                        <div class="dropdown-link" data-page-id="history">History</div>
                    </div>
                </li>
                <li><button id="installAppBtn" class="btn-install">Download App ‚¨áÔ∏è</button></li>
            </ul>
        </nav>

        <div class="header-actions">
            <div class="school-name">COGON NATIONAL HIGH SCHOOL &nbsp;&nbsp;&nbsp; | &nbsp;&nbsp;&nbsp; BABAK DISTRICT</div>
            <button id="publicFilesBtn" class="btn btn-primary" style="display: none;">Public</button>
            <button id="privateFilesBtn" class="btn btn-secondary" style="display: none;">Private</button>
            <button id="myClassesBtn" class="btn btn-secondary" style="display: none;">Classes</button>
            <button id="systemOverviewBtn" class="btn btn-secondary" style="display: none;">Admin</button>
            <button id="accountBtn" class="btn btn-secondary" style="display: none;">Account</button>
            <button id="logoutBtn" class="btn btn-danger" style="display: none;">Logout</button>
            <button class="mobile-toggle" id="mobileMenuBtn"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg></button>
        </div>
    </header>

    <div id="achievementBanner"><span id="achievementText">Welcome to Cogon National High School</span></div>
    <div id="welcomeBar">Welcome, <span id="currentUserId">User</span></div>
    <div id="mobileNav"><button id="closeMobileNav" class="close-modal" style="align-self: flex-end; position:relative; top:0; right:0;">&times;</button><div id="mobileNavContent" style="display: flex; flex-direction: column; gap: 15px;"></div></div>

    <main>
        <section id="landingPage" class="landing-hero">
            <img id="mainLogo" src="" style="display:none;" alt="School Logo" />
            <h1 class="hero-title">File Depot</h1>
            <p style="color: var(--text-muted); font-size: 1.25rem; max-width: 500px; margin-bottom: 50px; line-height: 1.6;">
                The official centralized document portal. Organized and accessible.
            </p>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                <button id="loginBtn" class="btn btn-primary" style="padding: 16px 40px; border-radius: 100px; font-size: 1.1rem;">Teacher Login</button>
                <button id="studentAccessBtn" class="btn btn-secondary" style="padding: 16px 40px; border-radius: 100px; font-size: 1.1rem;">Student Access</button>
            </div>
        </section>

        <section id="authSection" style="display: none;">
            <div style="max-width: 400px; margin: 60px auto;" class="card">
                <button id="backToLandingBtn" class="btn-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Back</button>
                <h2 style="text-align: center; margin-bottom: 30px; margin-top: 15px;">Teacher Login</h2>
                <form id="loginForm">
                    <div class="input-group"><input type="email" id="loginEmail" placeholder="Email Address" required /></div>
                    <div class="input-group">
                        <input type="password" id="loginPassword" placeholder="Password" required />
                        <span class="password-toggle" onclick="togglePassword('loginPassword')">üëÅÔ∏è</span>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%; margin-top: 10px;">Sign In</button>
                    <button type="button" id="forgotPasswordLink" style="background:none; border:none; color:var(--primary); text-decoration:underline; cursor:pointer; margin-top:20px; display:block; width:100%; text-align:center;">Forgot Password?</button>
                </form>
            </div>
        </section>

        <section id="publicRepositorySection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Public Repository</h2>
                <input type="text" id="searchInput" placeholder="Search files..." style="max-width: 300px;">
            </div>
            
            <div class="card" style="margin-bottom: 30px; max-width: 600px; margin-left:auto; margin-right:auto;">
                <h3>Add Public Content</h3>
                <div class="upload-instruction">
                    <span>üí°</span>
                    <div>
                        <strong>How to upload:</strong>
                        <div style="font-size:0.8em; margin-top:2px;">1. In Google Drive, Right-click your file/folder > Share > Copy Link.<br>2. Select Type below, paste the link, and click Upload.</div>
                    </div>
                </div>
                
                <form id="addPublicContentForm">
                    <div class="type-selector">
                        <label class="type-label"><input type="radio" name="publicType" value="file" checked> <span>üìÑ Single File</span></label>
                        <label class="type-label"><input type="radio" name="publicType" value="folder"> <span>üìÇ Whole Folder</span></label>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <input type="text" id="publicGoogleDriveLink" placeholder="Paste Google Drive Link here..." required />
                        <input type="text" id="publicDescription" placeholder="Description / File Name" required />
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                </form>
            </div>
            <div class="card table-container" style="padding:0; border:none;"><div id="materialsTableContainer"></div></div>
        </section>

        <section id="privateFilesSection" style="display: none;">
            <div class="section-header"><h2 class="section-title">My Private Files</h2></div>
            <div class="card" style="margin-bottom: 30px; max-width: 600px; margin-left:auto; margin-right:auto;">
                <h3>Add Private Content</h3>
                <div class="upload-instruction">
                    <span>üí°</span>
                    <div>
                        <strong>How to upload:</strong>
                        <div style="font-size:0.8em; margin-top:2px;">1. In Google Drive, Right-click your file/folder > Share > Copy Link.<br>2. Select Type below, paste the link, and click Save.</div>
                    </div>
                </div>
                <form id="addPrivateContentForm">
                    <div class="type-selector">
                        <label class="type-label"><input type="radio" name="privateType" value="file" checked> <span>üìÑ Single File</span></label>
                        <label class="type-label"><input type="radio" name="privateType" value="folder"> <span>üìÇ Whole Folder</span></label>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <input type="text" id="privateGoogleDriveLink" placeholder="Paste Google Drive Link here..." required />
                        <input type="text" id="privateDescription" placeholder="Description / File Name" required />
                        <button type="submit" class="btn btn-primary">Save Privately</button>
                    </div>
                </form>
            </div>
            <div class="card table-container" style="padding:0; border:none;"><div id="privateMaterialsTableContainer"></div></div>
        </section>

        <section id="classManagementSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title"><button id="backFromClassesBtn" class="btn-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Back</button> My Classes</h2>
            </div>
            <div class="card">
                <h3>Create New Class</h3>
                <form id="createClassForm" style="display: flex; gap: 10px; margin-top: 20px;">
                    <input type="text" id="newClassName" placeholder="Class Name (e.g. Grade 10 Science)" required />
                    <button type="submit" class="btn btn-primary">Create</button>
                </form>
            </div>
            <div id="myClassesContainer" class="grid-4"></div>
        </section>

        <section id="systemAdminPanel" style="display: none;">
            <div class="section-header"><h2 class="section-title"><button id="backFromSystemAdminBtn" class="btn-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Back</button> System Admin</h2></div>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="switchAdminTab('dashboard')">Dashboard</button>
                <button class="tab-btn" onclick="switchAdminTab('users')">Users</button>
                <button class="tab-btn" onclick="switchAdminTab('content')">Content</button>
                <button class="tab-btn" onclick="switchAdminTab('globalFiles')">Global Files</button>
            </div>

            <div id="adminTab-dashboard" class="admin-tab-content">
                <div id="systemOverviewContainer" class="grid-4"></div>
                <div class="card" style="margin-top: 20px;">
                     <h3>Achievements (Ticker)</h3>
                     <form id="achievementForm" style="display: flex; gap: 10px; margin-top: 15px;">
                        <input type="text" id="newAchievementText" placeholder="New announcement text" required />
                        <button type="submit" class="btn btn-primary">Add</button>
                    </form>
                    <div id="achievementsList" style="margin-top: 15px;"></div>
                </div>
            </div>

            <div id="adminTab-users" class="admin-tab-content" style="display: none;">
                <div class="grid-2">
                    <div class="card">
                        <h3>User Management</h3>
                        <input type="text" id="userSearchInput" placeholder="Search by email..." style="margin: 15px 0;">
                        <div id="userManagementContainer" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    <div class="card">
                        <h3>Create User</h3>
                        <form id="createUserForm" style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                            <input type="email" id="newUserEmail" placeholder="Email" required />
                            <input type="password" id="newUserPassword" placeholder="Password" required />
                            <button type="submit" class="btn btn-primary">Create Account</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="adminTab-content" class="admin-tab-content" style="display: none;">
                <div class="grid-2">
                    <div class="card">
                        <h3>General Settings</h3>
                         <form id="landingLogoForm" style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                            <label style="font-size:0.9em; font-weight:600;">Landing Page Logo</label>
                            <input type="text" id="landingLogoInput" placeholder="Google Drive Link for Logo" />
                            <button type="submit" class="btn btn-primary">Update Logo</button>
                        </form>
                        
                        <h3 style="margin-top:25px;">Manage Shortcuts</h3>
                        <form id="addShortcutForm" style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <input type="text" id="shortcutName" placeholder="Name" required style="flex:1" />
                            <input type="url" id="shortcutUrl" placeholder="URL" required style="flex:2" />
                            <button type="submit" class="btn btn-primary">Add</button>
                        </form>
                        <div id="adminShortcutsList" style="margin-top:15px; display:flex; flex-direction:column; gap:8px;"></div>
                    </div>
                    <div class="card">
                        <h3>Page Content (Text & Image)</h3>
                        <p style="color:var(--text-muted); font-size:0.8rem; margin-bottom:10px;">Select a page, add a Drive Link (Image) and/or Text.</p>
                        <form id="contentManagementForm" style="display: flex; flex-direction: column; gap: 10px;">
                            <select id="pageContentSelect">
                                <optgroup label="Announcements">
                                    <option value="calendar_of_activities">Calendar of Activities</option>
                                    <option value="exam_schedules">Exam Schedules</option>
                                    <option value="enrollment_requirements">Enrollment Requirements</option>
                                </optgroup>
                                <optgroup label="About">
                                    <option value="faculty_and_staff">Faculty & Staff</option>
                                    <option value="history">History</option>
                                </optgroup>
                            </select>
                            <input type="text" id="pageImageLink" placeholder="Google Drive Image Link (Anyone with link)" />
                            <textarea id="pageContentText" placeholder="Page Text Content..." style="height:150px; resize:vertical;"></textarea>
                            <button type="submit" class="btn btn-primary">Save Content</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="adminTab-globalFiles" class="admin-tab-content" style="display: none;">
                <div class="card">
                    <h3>Inspect User Files</h3>
                    <p style="color: var(--text-muted); font-size: 0.9em;">View files of regular users.</p>
                    <select id="globalFileUserSelect" style="margin: 15px 0;"><option value="">Select a User...</option></select>
                    <div id="globalUserFilesContainer"></div>
                </div>
            </div>
        </section>

        <section id="updatePasswordSection" style="display: none;">
            <div style="max-width: 400px; margin: 40px auto;" class="card">
                 <button id="backFromPasswordBtn" class="btn-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Back</button>
                <h3 style="text-align: center; margin-bottom: 20px; margin-top:15px;">Account Settings</h3>
                <form id="updatePasswordForm" style="display: flex; flex-direction: column; gap: 10px;">
                    <div class="input-group">
                        <input type="password" id="newPasswordInput" placeholder="New Password" required />
                        <span class="password-toggle" onclick="togglePassword('newPasswordInput')">üëÅÔ∏è</span>
                    </div>
                    <div class="input-group">
                        <input type="password" id="confirmNewPasswordInput" placeholder="Confirm Password" required />
                        <span class="password-toggle" onclick="togglePassword('confirmNewPasswordInput')">üëÅÔ∏è</span>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Password</button>
                </form>
            </div>
        </section>

        <section id="studentAccessSection" style="display: none;">
            <div class="card" style="max-width: 600px; margin: 60px auto;">
                <button id="backFromStudentAccessBtn" class="btn-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Back</button>
                <h2 style="text-align: center; margin-top:15px;">Student Access</h2>
                <form id="studentAccessForm" style="display: flex; gap: 10px; margin: 20px 0;">
                    <input type="text" id="classKeyInput" placeholder="Enter Class Key" required />
                    <button type="submit" class="btn btn-primary">Open</button>
                </form>
                <div id="studentClassFilesContainer"></div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div id="footerText"></div>
    </footer>

    <div id="forgotPasswordModal" class="modal"><div class="modal-content standard" style="max-width: 400px; text-align: center;"><button class="close-modal">&times;</button><h3>Reset Password</h3><form id="forgotPasswordForm" style="margin-top:20px; display: flex; flex-direction: column; gap: 10px;"><input type="email" id="forgotPasswordEmail" placeholder="Email Address" required><button type="submit" class="btn btn-primary">Send Link</button></form></div></div>
    
    <div id="confirmationModal" class="modal">
        <div class="modal-content danger">
            <div class="modal-icon-wrapper">üóëÔ∏è</div>
            <h3 class="modal-title">Delete Item?</h3>
            <p id="confirmationMessage" class="modal-text">Are you sure you want to delete this item? This action cannot be undone.</p>
            <div class="modal-actions">
                <button id="cancelModalBtn" class="btn-modal-cancel">Cancel</button>
                <button id="confirmActionBtn" class="btn-modal-delete">Yes, Delete</button>
            </div>
        </div>
    </div>
    
    <div id="contentModal" class="modal">
        <div class="modal-content pinned-paper">
            <button class="close-modal modal-close-btn">&times;</button>
            <h2 id="contentModalTitle"></h2>
            <div id="contentModalBody"></div>
        </div>
    </div>
    
    <div id="userListModal" class="modal">
        <div class="modal-content standard" style="max-width:500px">
            <button class="close-modal">&times;</button>
            <h3 id="userListModalTitle">Users</h3>
            <div id="userListModalBody" style="margin-top:15px; max-height:400px; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="editClassModal" class="modal"><div class="modal-content standard" style="max-width:400px;"><button class="close-modal">&times;</button><h3>Edit Class Name</h3><form id="editClassForm" style="margin-top:15px; display:flex; gap:10px;"><input type="text" id="editClassNameInput" required /><button type="submit" class="btn btn-primary">Save</button></form></div></div>
    
    <div id="editFileModal" class="modal">
        <div class="modal-content standard" style="max-width:500px;">
            <button class="close-modal">&times;</button>
            <h3>Edit File</h3>
            <form id="editFileForm" style="margin-top:15px; display:flex; flex-direction:column; gap:10px;">
                <label style="font-size:0.9em; font-weight:600;">Description/Name</label>
                <input type="text" id="editFileDescInput" required />
                <label style="font-size:0.9em; font-weight:600;">Google Drive Link</label>
                <input type="text" id="editFileLinkInput" required />
                <button type="submit" class="btn btn-primary" style="margin-top:10px;">Update File</button>
            </form>
        </div>
    </div>

    <div id="classFilesModal" class="modal">
        <div class="modal-content modern-files">
            <div class="file-manager-header">
                <h3 id="classFilesModalTitle" style="margin:0;">Manage Files</h3>
                <button class="close-modal" id="classFilesModalCloseBtn" style="position:static;">&times;</button>
            </div>
            <div class="file-manager-body">
                <div class="upload-instruction">
                    <span>üí°</span>
                    <div>
                        <strong>Add File to Class:</strong>
                        <div style="font-size:0.8em; margin-top:2px;">Paste Google Drive link. System will auto-convert files.</div>
                    </div>
                </div>

                <form id="addClassFileForm" style="display: flex; gap: 10px; margin-bottom: 20px; background:#f9fafb; padding:15px; border-radius:8px;">
                    <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
                        <input type="text" id="classGoogleDriveLink" placeholder="Paste Google Drive Link here..." required />
                        <input type="text" id="classFileDescription" placeholder="File Description" required />
                    </div>
                     <button type="submit" class="btn btn-primary" style="align-self: flex-end; margin-bottom:2px;">Add File</button>
                </form>
                <div id="classFilesTableContainer"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js" async></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updatePassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, get, push, remove, onValue, serverTimestamp, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyArVK4JdqGYYMk2rlOLcwenCBzJIWOVYg8", authDomain: "igacoslr.firebaseapp.com", projectId: "igacoslr", storageBucket: "igacoslr.appspot.com", messagingSenderId: "168499425895", appId: "1:168499425895:web:1e32d9d1c8f52887f0dac2" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const SYSTEM_ADMIN_UID = 'ei66KvfdRjakTEycf2acPG3EQo73';

        const DOM = {
            loader: document.getElementById('loader'), toastContainer: document.getElementById('toastContainer'),
            landingPage: document.getElementById('landingPage'), authSection: document.getElementById('authSection'), 
            publicRepository: document.getElementById('publicRepositorySection'), privateFiles: document.getElementById('privateFilesSection'),
            classManagement: document.getElementById('classManagementSection'), systemAdmin: document.getElementById('systemAdminPanel'), 
            passwordSection: document.getElementById('updatePasswordSection'), studentAccess: document.getElementById('studentAccessSection'),
            
            loginBtn: document.getElementById('loginBtn'), studentAccessBtn: document.getElementById('studentAccessBtn'), logoutBtn: document.getElementById('logoutBtn'),
            publicFilesBtn: document.getElementById('publicFilesBtn'), privateFilesBtn: document.getElementById('privateFilesBtn'),
            myClassesBtn: document.getElementById('myClassesBtn'), systemOverviewBtn: document.getElementById('systemOverviewBtn'), accountBtn: document.getElementById('accountBtn'),
            userDisplay: document.getElementById('userDisplay'), currentUserId: document.getElementById('currentUserId'),
            achievementBanner: document.getElementById('achievementBanner'), achievementText: document.getElementById('achievementText'),
            lightbox: document.getElementById('lightbox'), lightboxImg: document.getElementById('lightboxImg'),
            mainLogo: document.getElementById('mainLogo'),
            installAppBtn: document.getElementById('installAppBtn'),
            schoolName: document.querySelector('.school-name'),
            welcomeBar: document.getElementById('welcomeBar')
        };

        let AppState = { currentUser: null, isAdmin: false, isSystemAdmin: false, allMaterials: [], actionHandler: null, editContext: null };

        const y = new Date().getFullYear();
        document.getElementById('footerText').textContent = `¬© ${y-1}-${y} Cogon National High School. Made with ‚ù§Ô∏è by Ram.`;

        const showToast = (msg, type='info') => { const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = msg; DOM.toastContainer.appendChild(toast); setTimeout(()=>toast.remove(), 4000); }
        window.copyToClipboard = (text) => navigator.clipboard.writeText(text).then(() => showToast("Copied!", "success"));
        window.togglePassword = (id) => { const inp = document.getElementById(id); inp.type = inp.type === 'password' ? 'text' : 'password'; }
        window.switchAdminTab = (tabName) => {
            document.querySelectorAll('.admin-tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`adminTab-${tabName}`).style.display = 'block';
            event.target.classList.add('active');
        }

        const setActiveNav = (activeId) => {
            ['publicFilesBtn', 'privateFilesBtn', 'myClassesBtn', 'systemOverviewBtn', 'accountBtn'].forEach(id => {
                const btn = document.getElementById(id);
                if(btn) {
                    if(id === activeId) {
                        btn.classList.remove('btn-secondary');
                        btn.classList.add('btn-primary');
                    } else {
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-secondary');
                    }
                }
            });
        }
        
        const convertDriveLink = (url) => {
            if(!url) return null;
            let id = null;
            if(url.includes('drive.google.com/file/d/')) {
                id = url.match(/\/d\/([a-zA-Z0-9_-]+)/)?.[1];
            } else if (url.includes('id=')) {
                id = url.match(/id=([a-zA-Z0-9_-]+)/)?.[1];
            }
            return id ? `https://drive.google.com/uc?export=download&id=${id}` : url;
        }

        const getDriveImg = (url) => {
            if(!url) return null;
            let id = null;
            if(url.includes('drive.google.com/file/d/')) {
                id = url.match(/\/d\/([a-zA-Z0-9_-]+)/)?.[1];
            } else if (url.includes('id=')) {
                id = url.match(/id=([a-zA-Z0-9_-]+)/)?.[1];
            }
            return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w1000` : url; 
        }

        const updateUI = async (user) => {
            AppState.currentUser = user;
            DOM.loader.style.opacity = '0'; setTimeout(()=>DOM.loader.style.display='none', 500);

            [DOM.landingPage, DOM.authSection, DOM.publicRepository, DOM.privateFiles, DOM.classManagement, DOM.systemAdmin, DOM.passwordSection, DOM.studentAccess].forEach(el=>el.style.display='none');
            [DOM.logoutBtn, DOM.publicFilesBtn, DOM.privateFilesBtn, DOM.myClassesBtn, DOM.systemOverviewBtn, DOM.accountBtn, DOM.welcomeBar].forEach(el=>el.style.display='none');

            get(ref(db, 'settings/logo')).then(s => {
                if(s.exists() && s.val()) {
                    DOM.mainLogo.src = getDriveImg(s.val());
                    DOM.mainLogo.style.display = 'block';
                }
            });

            if(user) {
            
                DOM.schoolName.style.display = 'none';
                DOM.welcomeBar.style.display = 'flex';
                
                const adminRef = ref(db, `admins/${user.uid}`);
                const snap = await get(adminRef);
                AppState.isAdmin = snap.exists() || user.uid === SYSTEM_ADMIN_UID;
                AppState.isSystemAdmin = user.uid === SYSTEM_ADMIN_UID;

                DOM.currentUserId.textContent = user.email.split('@')[0];
                DOM.logoutBtn.style.display = 'block'; DOM.accountBtn.style.display = 'block';
                DOM.publicFilesBtn.style.display = 'block'; DOM.privateFilesBtn.style.display = 'block';
                DOM.myClassesBtn.style.display = 'block';

                if(AppState.isAdmin) {
                    DOM.systemAdmin.style.display = 'block'; DOM.systemOverviewBtn.style.display = 'block';
                    setActiveNav('systemOverviewBtn');
                    loadSystemAdminData();
                } else {
                    DOM.publicRepository.style.display = 'block';
                    setActiveNav('publicFilesBtn');
                }
                initListeners();
            } else {
    
                DOM.schoolName.style.display = ''; 
                DOM.welcomeBar.style.display = 'none';
                DOM.landingPage.style.display = 'flex';
                initPublicShortcuts(); initListeners();
            }
        }

        const initPublicShortcuts = () => onValue(ref(db, 'shortcuts'), (s) => {
            const drop = document.getElementById('shortcutsDropdown');
            if(!s.exists()) { drop.innerHTML = '<span class="dropdown-link" style="opacity:0.6; font-size:0.8rem">No shortcuts</span>'; return; }
            drop.innerHTML = ''; s.forEach(child => { drop.innerHTML += `<a href="${child.val().url}" target="_blank" class="dropdown-link">${child.val().name}</a>`; });
        });

        const initListeners = () => {
            onValue(ref(db, 'educationalMaterials'), (s) => processMaterials(s, 'file', true));
            onValue(ref(db, 'educationalFolders'), (s) => processMaterials(s, 'folder', true));
            if(AppState.currentUser) {
                onValue(ref(db, `userMaterials/${AppState.currentUser.uid}`), (s) => renderPrivateFiles(s.val(), 'privateMaterialsTableContainer'));
            }
            onValue(ref(db, 'achievements'), (s) => {
                if(s.exists()) { const list = Object.values(s.val()); if(list.length > 0) {
                    DOM.achievementBanner.style.display = 'flex'; let idx = 0;
                    setInterval(() => { DOM.achievementText.style.opacity = 0; setTimeout(() => { DOM.achievementText.textContent = list[idx].text; DOM.achievementText.style.opacity = 1; idx = (idx + 1) % list.length; }, 500); }, 5000);
                }}
            });
        }

        const processMaterials = (snap, type, isPublic) => {
            if(!snap.exists()) return; const data = snap.val();
            Object.keys(data).forEach(key => {
                const item = { ...data[key], id: key, type, isPublic };
                const idx = AppState.allMaterials.findIndex(m=>m.id === key);
                if(idx > -1) AppState.allMaterials[idx] = item; else AppState.allMaterials.push(item);
            });
            renderAllMaterials();
        }

        const incrementDownload = (id, type, isPublic) => {
            const path = isPublic 
                ? (type === 'folder' ? `educationalFolders/${id}` : `educationalMaterials/${id}`)
                : `userMaterials/${AppState.currentUser.uid}/${id}`;
            runTransaction(ref(db, `${path}/downloadCount`), (current) => (current || 0) + 1);
        }
        window.trackDownload = (id, type, isPublic) => incrementDownload(id, type, isPublic);

        const renderAllMaterials = () => {
            const container = document.getElementById('materialsTableContainer');
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = AppState.allMaterials.filter(m => m.isPublic && m.description.toLowerCase().includes(term));
            
            if(filtered.length === 0) { container.innerHTML = '<div style="padding:40px; text-align:center; color:#6b7280;">No public files found.</div>'; return; }

            let html = `<table class="table"><thead><tr><th>Description</th><th>Type</th><th>Action</th><th>Status</th>${AppState.isAdmin ? '<th style="text-align:right">Admin</th>' : ''}</tr></thead><tbody>`;
            
            filtered.forEach(m => {
                const ownerId = m.addedBy || m.ownerId;
                const icon = m.type === 'folder' ? 'üìÇ' : 'üìÑ';
                const dlCount = m.downloadCount || 0;
                
                let actionBtn;
                if(m.type === 'folder') {
                    actionBtn = `<a href="${m.link}" target="_blank" onclick="window.trackDownload('${m.id}','folder',true)" class="btn btn-secondary">Open</a>`;
                } else {
                    actionBtn = `<a href="${m.link}" target="_blank" onclick="window.trackDownload('${m.id}','file',true)" class="btn btn-primary">Download</a>`;
                }

                const isOwner = AppState.currentUser && (ownerId === AppState.currentUser.uid || AppState.isSystemAdmin);
                
                const statusHTML = isOwner
                    ? `<label class="switch"><input type="checkbox" class="share-toggle" data-id="${m.id}" data-owner-id="${ownerId}" data-type="${m.type}" checked><span class="slider"></span></label>`
                    : `<span class="badge badge-public">Public</span>`;

                const adminActions = AppState.isAdmin 
                    ? `<td style="text-align:right; white-space:nowrap;">
                           <button class="btn-icon edit-file-btn" data-id="${m.id}" data-type="${m.type}" data-is-public="true" style="color:#0ea5e9;">‚úèÔ∏è</button>
                           <button class="btn-icon delete-btn" data-id="${m.id}" data-type="${m.type}" data-is-public="true" style="color:#ef4444;">üóëÔ∏è</button>
                       </td>` 
                    : '';

                html += `<tr>
                    <td>
                        <div>${icon} ${m.description}</div>
                        <div class="download-count">‚¨áÔ∏è ${dlCount}</div>
                    </td>
                    <td><span style="border:1px solid #e5e7eb; padding:2px 6px; border-radius:4px; font-size:0.75em; font-weight:600;">${m.type.toUpperCase()}</span></td>
                    <td style="text-align:left">${actionBtn}</td>
                    <td style="text-align:left">${statusHTML}</td>
                    ${adminActions}
                </tr>`;
            });
            html += '</tbody></table>'; container.innerHTML = html;
        }

        const renderPrivateFiles = (data, containerId) => {
            const container = document.getElementById(containerId);
            if(!data) { container.innerHTML = '<div style="padding:40px; text-align:center; color:#6b7280;">No private files yet.</div>'; return; }
            let html = `<table class="table"><thead><tr><th>Description</th><th>Public?</th><th style="text-align:right">Action</th></tr></thead><tbody>`;
            Object.keys(data).forEach(key => {
                const m = data[key]; const icon = m.type === 'folder' ? 'üìÇ' : 'üìÑ';
                const dlCount = m.downloadCount || 0;
                
                let actionBtn;
                if(m.type === 'folder') {
                    actionBtn = `<a href="${m.link}" target="_blank" onclick="window.trackDownload('${key}','folder',false)" class="btn btn-secondary" style="padding:5px 10px;">Open</a>`;
                } else {
                    actionBtn = `<a href="${m.link}" target="_blank" onclick="window.trackDownload('${key}','file',false)" class="btn btn-secondary" style="padding:5px 10px;">Open</a>`;
                }

                html += `<tr>
                    <td>
                        <div>${icon} ${m.description}</div>
                        <div class="download-count">‚¨áÔ∏è ${dlCount}</div>
                    </td>
                    <td style="text-align:center"><label class="switch"><input type="checkbox" class="share-toggle" data-id="${key}" data-owner-id="${AppState.currentUser.uid}" data-type="${m.type}"><span class="slider"></span></label></td>
                    <td style="text-align:right; display:flex; justify-content:flex-end; gap:5px;">
                        ${actionBtn}
                        <button class="btn-icon edit-file-btn" data-id="${key}" data-type="${m.type}" data-is-public="false" style="color:#0ea5e9;">‚úèÔ∏è</button>
                        <button class="btn-icon delete-btn" data-id="${key}" data-is-public="false" style="color:#ef4444;">üóëÔ∏è</button>
                    </td></tr>`;
            });
            html += '</tbody></table>'; container.innerHTML = html;
        }

        const loadClasses = () => {
             const c = document.getElementById('myClassesContainer');
             c.innerHTML = '<div class="spinner"></div>';
             onValue(ref(db, 'classes'), (s) => {
                 c.innerHTML = '';
                 if(!s.exists()) { c.innerHTML = '<p>No classes found.</p>'; return; }
                 s.forEach(child => {
                     const cls = child.val();
                     if(cls.ownerId === AppState.currentUser.uid) {
                         const div = document.createElement('div');
                         div.className = 'card';
                         div.style.padding = '20px';
                         div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><h4>${cls.className}</h4><button class="btn-icon edit-class-btn" data-key="${child.key}" data-name="${cls.className}" style="color:#0ea5e9;">‚úèÔ∏è</button></div>
                             <p style="color:var(--text-muted); font-size:0.9em; margin:10px 0;">Access Key: <strong style="color:var(--primary); cursor:pointer; text-decoration:underline;" class="copy-key" data-key="${cls.accessKey}">${cls.accessKey}</strong></p>
                             <div style="display:flex; gap:10px;">
                                <button class="btn btn-secondary" onclick="window.manageClass('${child.key}', '${cls.className}')">Files</button>
                                <button class="btn-icon delete-class-btn" data-key="${child.key}" style="color:#ef4444;">üóëÔ∏è</button>
                             </div>`;
                         c.appendChild(div);
                     }
                 });
             });
        }
        
        window.manageClass = (key, name) => {
            const modal = document.getElementById('classFilesModal');
            modal.classList.add('active');
            modal.dataset.key = key;
            document.getElementById('classFilesModalTitle').textContent = name;
            onValue(ref(db, `classes/${key}/materials`), (s) => {
                const tbl = document.getElementById('classFilesTableContainer');
                if(!s.exists()) { tbl.innerHTML = '<p style="text-align:center; color:#888; margin-top:50px;">No files in this class.</p>'; return; }
                let h = '';
                s.forEach(f => {
                    const desc = f.val().description;
                    const link = f.val().link;
                    h += `<div class="file-item">
                        <div class="file-icon">üìÑ</div>
                        <div class="file-info">
                            <a href="${link}" target="_blank" class="file-name" style="text-decoration:none; color:inherit;">${desc}</a>
                            <span class="file-meta">Click to download</span>
                        </div>
                         <button onclick="window.removeClassFile('${key}', '${f.key}')" style="color:red; background:none; border:none; cursor:pointer; font-size:1.2rem">&times;</button>
                    </div>`;
                });
                tbl.innerHTML = h;
            });
        }
        window.removeClassFile = (classKey, fileKey) => remove(ref(db, `classes/${classKey}/materials/${fileKey}`));


        const loadSystemAdminData = () => {
            let localUsers = {};
            let localAdmins = {};

            const renderAdminUI = () => {
                let adminCount = 0;
                let userCount = 0;
                let adminListHTML = '<ul style="list-style:none; padding:0;">';
                let userListHTML = '<ul style="list-style:none; padding:0;">';
                let managementTable = '<table class="table"><thead><tr><th>User</th><th>Role</th><th style="text-align:right">Action</th></tr></thead><tbody>';

                Object.keys(localUsers).forEach(uid => {
                    const email = localUsers[uid].email;
                    const isDisabled = localUsers[uid].isDisabled === true;
                    const isAdmin = localAdmins[uid] || uid === SYSTEM_ADMIN_UID;
                    const isSelf = uid === AppState.currentUser.uid;
                    
                    let roleBadge = isAdmin ? '<span class="badge badge-admin">Admin</span>' : '<span class="badge badge-user">Teacher</span>';
                    if (isDisabled) roleBadge += ' <span class="badge badge-disabled">Disabled</span>';
                    
                    if(isAdmin) {
                        adminCount++;
                        adminListHTML += `<li style="padding:10px; border-bottom:1px solid #eee;">${email}</li>`;
                    } else {
                        userCount++;
                        userListHTML += `<li style="padding:10px; border-bottom:1px solid #eee;">${email}</li>`;
                    }

                    if(uid !== SYSTEM_ADMIN_UID) {
                        managementTable += `<tr>
                            <td>${email}</td>
                            <td>${roleBadge}</td>
                            <td style="text-align:right; white-space:nowrap;">`;

                    
                        if (isSelf) {
                             managementTable += `<span style="color:var(--text-muted); font-size:0.8rem; font-style:italic;">Current User</span>`;
                        } else {
                            managementTable += `
                                <button class="btn btn-secondary" style="font-size:0.8em; margin-right:5px;" onclick="window.toggleAdmin('${uid}','${email}', ${!isAdmin})">${isAdmin ? 'Revoke Admin' : 'Make Admin'}</button>
                                <button class="btn btn-warning" onclick="window.toggleDisable('${uid}', ${!isDisabled})">${isDisabled ? 'Enable' : 'Disable'}</button>
                            `;
                        }

                        managementTable += `</td></tr>`;
                    }
                });
                adminListHTML += '</ul>';
                userListHTML += '</ul>';
                managementTable += '</tbody></table>';

                const overview = document.getElementById('systemOverviewContainer');
                if(overview) {
                    overview.innerHTML = `
                    <div class="stat-card" onclick="window.showUserList('Admins', '${btoa(adminListHTML)}')">
                        <div class="stat-number" style="color:var(--primary)">${adminCount}</div>
                        <div class="stat-label">Admins</div>
                    </div>
                    <div class="stat-card" onclick="window.showUserList('Teachers', '${btoa(userListHTML)}')">
                        <div class="stat-number" style="color:#166534">${userCount}</div>
                        <div class="stat-label">Teachers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${adminCount + userCount}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                `;
                }

                const container = document.getElementById('userManagementContainer');
                if(container) container.innerHTML = managementTable;
            };

            onValue(ref(db, 'users'), (s) => {
                localUsers = s.val() || {};
                renderAdminUI();
            });

            onValue(ref(db, 'admins'), (s) => {
                localAdmins = s.val() || {};
                renderAdminUI();
            });

            window.showUserList = (title, b64Html) => {
                document.getElementById('userListModalTitle').textContent = title;
                document.getElementById('userListModalBody').innerHTML = atob(b64Html);
                document.getElementById('userListModal').classList.add('active');
            }
            

            window.toggleDisable = async (uid, shouldDisable) => {
                await update(ref(db, `users/${uid}`), { isDisabled: shouldDisable });
                showToast(shouldDisable ? "User Disabled" : "User Enabled");
            }

            const sel = document.getElementById('globalFileUserSelect');
            onValue(ref(db, 'users'), s => {
                sel.innerHTML = '<option value="">Select a User...</option>';
                s.forEach(u => { if(u.key !== SYSTEM_ADMIN_UID) sel.innerHTML += `<option value="${u.key}">${u.val().email}</option>`; });
            });
            sel.addEventListener('change', async (e) => {
                const uid = e.target.value;
                const c = document.getElementById('globalUserFilesContainer');
                if(!uid) { c.innerHTML=''; return; }
                const snap = await get(ref(db, `userMaterials/${uid}`));
                if(!snap.exists()) { c.innerHTML = '<p>No private files.</p>'; return; }
                let h = '<table class="table"><tbody>';
                const data = snap.val();
                Object.keys(data).forEach(k => { h += `<tr><td>${data[k].type === 'folder'?'üìÇ':'üìÑ'} ${data[k].description}</td><td style="text-align:right"><a href="${data[k].link}" target="_blank" class="btn btn-secondary">Open</a></td></tr>`; });
                h += '</tbody></table>'; c.innerHTML = h;
            });
            
            const list = document.getElementById('achievementsList');
            onValue(ref(db, 'achievements'), s => {
                list.innerHTML = '';
                if(s.exists()) {
                    s.forEach(c => {
                        list.innerHTML += `<div style="display:flex; justify-content:space-between; background:rgba(0,0,0,0.03); padding:10px; border-radius:8px; margin-bottom:5px;">${c.val().text} <button onclick="window.removeAchievement('${c.key}')" style="background:none; border:none; color:#ef4444; cursor:pointer;">&times;</button></div>`;
                    });
                }
            });
            window.removeAchievement = (k) => remove(ref(db, `achievements/${k}`));

            const scList = document.getElementById('adminShortcutsList');
            onValue(ref(db, 'shortcuts'), s => {
                scList.innerHTML = '';
                if(s.exists()) {
                    s.forEach(c => {
                        scList.innerHTML += `<div style="display:flex; justify-content:space-between; background:rgba(0,0,0,0.03); padding:10px; border-radius:8px;">
                            <span>${c.val().name}</span>
                            <button onclick="window.removeShortcut('${c.key}')" style="background:none; border:none; color:#ef4444; cursor:pointer;">&times;</button>
                        </div>`;
                    });
                }
            });
            window.removeShortcut = (k) => remove(ref(db, `shortcuts/${k}`));
            window.toggleAdmin = (uid, email, promote) => {
                if(promote) set(ref(db, `admins/${uid}`), {email});
                else remove(ref(db, `admins/${uid}`));
            }
        }

        document.body.addEventListener('click', async (e) => {
            if(e.target.closest('.nav-item')) {
                const item = e.target.closest('.nav-item');

                if(item.querySelector('.dropdown-menu')) {
                    if(!e.target.closest('.dropdown-link')) {

                        document.querySelectorAll('.nav-item').forEach(i => { if(i!==item) i.classList.remove('active'); });
                        item.classList.toggle('active');
                    }
                }
            } else {

                 if(!e.target.closest('#mobileNav')) {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                 }
            }

            if(e.target.id === 'publicFilesBtn') {
                [DOM.privateFiles, DOM.classManagement, DOM.systemAdmin, DOM.passwordSection].forEach(el=>el.style.display='none');
                DOM.publicRepository.style.display='block';
                setActiveNav('publicFilesBtn');
            }
            if(e.target.id === 'privateFilesBtn') {
                [DOM.publicRepository, DOM.classManagement, DOM.systemAdmin, DOM.passwordSection].forEach(el=>el.style.display='none');
                DOM.privateFiles.style.display='block';
                setActiveNav('privateFilesBtn');
            }
            if(e.target.id === 'myClassesBtn') {
                [DOM.publicRepository, DOM.privateFiles, DOM.systemAdmin, DOM.passwordSection].forEach(el=>el.style.display='none');
                DOM.classManagement.style.display='block'; loadClasses();
                setActiveNav('myClassesBtn');
            }
            if(e.target.id === 'systemOverviewBtn') {
                [DOM.publicRepository, DOM.privateFiles, DOM.classManagement, DOM.passwordSection].forEach(el=>el.style.display='none');
                DOM.systemAdmin.style.display='block';
                setActiveNav('systemOverviewBtn');
            }
            if(e.target.id === 'accountBtn') {
                [DOM.publicRepository, DOM.privateFiles, DOM.classManagement, DOM.systemAdmin].forEach(el=>el.style.display='none');
                DOM.passwordSection.style.display='block';
                setActiveNav('accountBtn');
            }
            if(e.target.id === 'backFromClassesBtn' || e.target.id === 'backFromPasswordBtn' || e.target.id === 'backFromSystemAdminBtn') {
                [DOM.privateFiles, DOM.classManagement, DOM.systemAdmin, DOM.passwordSection].forEach(el=>el.style.display='none');
                DOM.publicRepository.style.display='block';
                setActiveNav('publicFilesBtn');
            }
            
            if(e.target.classList.contains('share-toggle')) {
                const {id, ownerId, type} = e.target.dataset;
                const isNowPublic = e.target.checked;
                
                const publicCol = type === 'folder' ? 'educationalFolders' : 'educationalMaterials';
                const privatePath = `userMaterials/${ownerId}/${id}`;
                const publicPath = `${publicCol}/${id}`;

                if(isNowPublic) {
                    const s = await get(ref(db, privatePath));
                    if(s.exists()) {
                        await set(ref(db, publicPath), { ...s.val(), isPublic: true, addedBy: ownerId });
                        await remove(ref(db, privatePath));
                        showToast("File Moved to Public");
                    }
                } else {
                    const s = await get(ref(db, publicPath));
                    if(s.exists()) {
                        await set(ref(db, privatePath), { ...s.val(), isPublic: false, addedBy: ownerId }); 
                        await remove(ref(db, publicPath));
                        showToast("File Moved to Private");
                        AppState.allMaterials = AppState.allMaterials.filter(m=>m.id !== id);
                        renderAllMaterials();
                    }
                }
            }
            
            if(e.target.closest('.dropdown-link') && e.target.closest('.dropdown-link').dataset.pageId) {
                const pid = e.target.closest('.dropdown-link').dataset.pageId;
                const modal = document.getElementById('contentModal');
                const body = document.getElementById('contentModalBody');
                document.getElementById('contentModalTitle').textContent = e.target.textContent;
                
                modal.classList.add('active');
                body.innerHTML = '<div class="spinner"></div>';
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                

                document.getElementById('mobileNav').classList.remove('open');

                const s = await get(ref(db, `pageContent/${pid}`));
                body.innerHTML = '';
                if(s.exists()) {
                    const val = s.val();
                    if(val.image) {
                        body.innerHTML += `<img src="${getDriveImg(val.image)}" class="zoomable-img" referrerpolicy="no-referrer" onerror="this.style.display='none'" style="width:100%; max-height:350px; object-fit:contain; border-radius:4px; margin-bottom:25px; box-shadow:0 4px 10px rgba(0,0,0,0.15); border:4px solid white; display:block; margin-left:auto; margin-right:auto; cursor:zoom-in;">`;
                    }
                    if(val.text) body.innerHTML += `<div style="white-space: pre-wrap; color:#444;">${val.text}</div>`;
                    if(!val.image && !val.text) body.innerHTML = '<p>No content available for this section yet.</p>';
                } else {
                    body.innerHTML = '<p>No content available for this section yet.</p>';
                }
            }

            if(e.target.classList.contains('zoomable-img')) {
                DOM.lightboxImg.src = e.target.src;
                DOM.lightbox.style.display = 'flex';
            }
            

             if(e.target.closest('.delete-btn')) {
                const btn = e.target.closest('.delete-btn');
                document.getElementById('confirmationModal').classList.add('active');
                document.getElementById('confirmationMessage').textContent = "Are you sure you want to delete this file? This cannot be undone.";
                AppState.actionHandler = async () => {
                    const collection = btn.dataset.isPublic === 'true' 
                        ? (btn.dataset.type === 'folder' ? 'educationalFolders' : 'educationalMaterials') 
                        : `userMaterials/${AppState.currentUser.uid}`;
                    await remove(ref(db, `${collection}/${btn.dataset.id}`));
                    showToast('Deleted.', 'success');
                    document.getElementById('confirmationModal').classList.remove('active');
                    if(btn.dataset.isPublic === 'true') {
                        AppState.allMaterials = AppState.allMaterials.filter(m=>m.id !== btn.dataset.id);
                        renderAllMaterials();
                    }
                }
            }
            

             if(e.target.closest('.delete-class-btn')) {
                 const btn = e.target.closest('.delete-class-btn');
                 document.getElementById('confirmationModal').classList.add('active');
                 document.getElementById('confirmationMessage').textContent = "Are you sure you want to delete this class? This cannot be undone.";
                 AppState.actionHandler = async () => {
                     await remove(ref(db, `classes/${btn.dataset.key}`));
                     showToast("Class deleted.", "success");
                     document.getElementById('confirmationModal').classList.remove('active');
                 }
             }

             if(e.target.classList.contains('copy-key')) {
                 await navigator.clipboard.writeText(e.target.dataset.key);
                 showToast("Access Key Copied!", "success");
             }

            if(e.target.closest('.edit-class-btn')) {
                const btn = e.target.closest('.edit-class-btn');
                document.getElementById('editClassModal').classList.add('active');
                document.getElementById('editClassNameInput').value = btn.dataset.name;
                AppState.editContext = { type: 'class', key: btn.dataset.key };
            }

            if(e.target.closest('.edit-file-btn')) {
                const btn = e.target.closest('.edit-file-btn');
                const isPublic = btn.dataset.isPublic === 'true';
                const collection = isPublic 
                    ? (btn.dataset.type === 'folder' ? 'educationalFolders' : 'educationalMaterials') 
                    : `userMaterials/${AppState.currentUser.uid}`;
                
                const snap = await get(ref(db, `${collection}/${btn.dataset.id}`));
                if(snap.exists()) {
                    document.getElementById('editFileDescInput').value = snap.val().description;
                    document.getElementById('editFileLinkInput').value = snap.val().link;
                    AppState.editContext = { type: 'file', path: `${collection}/${btn.dataset.id}` };
                    document.getElementById('editFileModal').classList.add('active');
                }
            }
            
             if(e.target.classList.contains('close-modal') || e.target.id === 'cancelModalBtn') {
                document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active'));
            }
        });
        
        const forgotBtn = document.getElementById('forgotPasswordLink');
        if(forgotBtn) {
            forgotBtn.addEventListener('click', () => {
                document.getElementById('forgotPasswordModal').classList.add('active');
            });
        }
        
        document.getElementById('confirmActionBtn').addEventListener('click', () => {
             if(AppState.actionHandler) AppState.actionHandler();
        });


        document.getElementById('editClassForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(AppState.editContext && AppState.editContext.type === 'class') {
                await update(ref(db, `classes/${AppState.editContext.key}`), { className: document.getElementById('editClassNameInput').value });
                showToast("Class renamed.");
                document.getElementById('editClassModal').classList.remove('active');
            }
        });

        document.getElementById('editFileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(AppState.editContext && AppState.editContext.type === 'file') {
                const rawLink = document.getElementById('editFileLinkInput').value;
                const finalLink = convertDriveLink(rawLink);
                await update(ref(db, AppState.editContext.path), { 
                    description: document.getElementById('editFileDescInput').value,
                    link: finalLink
                });
                showToast("File updated.");
                document.getElementById('editFileModal').classList.remove('active');
                if(AppState.editContext.path.startsWith('educational')) {
                     const snap = await get(ref(db, AppState.editContext.path.split('/')[0]));
                     processMaterials(snap, AppState.editContext.path.includes('Folder') ? 'folder' : 'file', true);
                }
            }
        });
        

        const setupForm = (id, cb) => document.getElementById(id).addEventListener('submit', async (e) => { e.preventDefault(); await cb(e); e.target.reset(); });

        setupForm('forgotPasswordForm', async () => {
             const email = document.getElementById('forgotPasswordEmail').value;
             try {
                await sendPasswordResetEmail(auth, email);
                showToast("Reset link sent! Check spam folder.", "success");
                document.getElementById('forgotPasswordModal').classList.remove('active');
             } catch(err) {
                 console.error(err);
                 if(err.code === 'auth/user-not-found') showToast("Email not found.", "error");
                 else showToast("Failed to send. Try again.", "error");
             }
        });

        setupForm('loginForm', async () => {
            try {
                const result = await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value);

                const user = result.user;
                const snap = await get(ref(db, `users/${user.uid}/isDisabled`));
                if(snap.exists() && snap.val() === true) {
                    await signOut(auth);
                    showToast("Your account has been disabled. Contact Admin.", "error");
                    return;
                }
            } catch (err) {
                console.error(err);
                if(err.code === 'auth/invalid-credential') showToast("Incorrect email or password.", "error");
                else showToast("Login failed. Check connection.", "error");
            }
        });

        setupForm('createClassForm', async () => { const k = `${new Date().getFullYear()}-${Math.floor(1000+Math.random()*9000)}`; await set(ref(db, `classes/${k}`), { className: document.getElementById('newClassName').value, accessKey: k, ownerId: AppState.currentUser.uid }); showToast("Class created!"); });
        
        setupForm('addClassFileForm', async () => { 
            const k = document.getElementById('classFilesModal').dataset.key;
            const rawLink = document.getElementById('classGoogleDriveLink').value;
            const finalLink = convertDriveLink(rawLink);
            await push(ref(db, `classes/${k}/materials`), { link: finalLink, description: document.getElementById('classFileDescription').value, type: 'file' }); 
        });
        
        setupForm('addPublicContentForm', async () => {
            const type = document.querySelector('input[name="publicType"]:checked').value;
            const rawLink = document.getElementById('publicGoogleDriveLink').value;
            const desc = document.getElementById('publicDescription').value;
            const finalLink = type === 'file' ? convertDriveLink(rawLink) : rawLink;
            const collection = type === 'file' ? 'educationalMaterials' : 'educationalFolders';
            await push(ref(db, collection), { link: finalLink, description: desc, type: type, isPublic: true, addedBy: AppState.currentUser.uid, createdAt: serverTimestamp(), downloadCount: 0 }); 
            showToast("Uploaded!"); 
        });

        setupForm('addPrivateContentForm', async () => {
            const type = document.querySelector('input[name="privateType"]:checked').value;
            const rawLink = document.getElementById('privateGoogleDriveLink').value;
            const desc = document.getElementById('privateDescription').value;
            const finalLink = type === 'file' ? convertDriveLink(rawLink) : rawLink;
            await push(ref(db, `userMaterials/${AppState.currentUser.uid}`), { link: finalLink, description: desc, type: type, isPublic: false, createdAt: serverTimestamp(), downloadCount: 0 }); 
            showToast("Saved Privately!"); 
        });
        

        setupForm('landingLogoForm', async () => {
            const link = document.getElementById('landingLogoInput').value;
            await set(ref(db, 'settings/logo'), link);
            showToast("Logo updated! Refresh to see changes.");
            DOM.mainLogo.src = getDriveImg(link);
            DOM.mainLogo.style.display = 'block';
        });

        setupForm('studentAccessForm', async () => {
            const k = document.getElementById('classKeyInput').value; const s = await get(ref(db, `classes/${k}`));
            const c = document.getElementById('studentClassFilesContainer'); c.innerHTML = '';
            if(!s.exists()) { showToast("Invalid Key", "error"); return; }
            if(s.val().materials) { Object.values(s.val().materials).forEach(m => { c.innerHTML += `<div class="card" style="padding:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">${m.description} <a href="${m.link}" target="_blank" class="btn btn-secondary">Open</a></div>`; }); } else { c.innerHTML = '<p style="text-align:center">No files.</p>'; }
        });
        
        setupForm('createUserForm', async () => { 
            const email = document.getElementById('newUserEmail').value;
            const res = await createUserWithEmailAndPassword(auth, email, document.getElementById('newUserPassword').value); 
            await set(ref(db, `users/${res.user.uid}`), { email: email });
            showToast("User created."); 
        });
        
        setupForm('achievementForm', async () => { await push(ref(db, 'achievements'), { text: document.getElementById('newAchievementText').value }); });
        setupForm('addShortcutForm', async () => { await push(ref(db, 'shortcuts'), { name: document.getElementById('shortcutName').value, url: document.getElementById('shortcutUrl').value }); showToast("Shortcut added!"); });
        
        setupForm('contentManagementForm', async () => { 
            const pid = document.getElementById('pageContentSelect').value; 
            const text = document.getElementById('pageContentText').value;
            const image = document.getElementById('pageImageLink').value;
            await set(ref(db, `pageContent/${pid}`), { text, image }); 
            showToast("Saved."); 
        });
        
        setupForm('updatePasswordForm', async () => { const p1 = document.getElementById('newPasswordInput').value; const p2 = document.getElementById('confirmNewPasswordInput').value; if(p1 !== p2) { showToast("Passwords do not match", "error"); return; } await updatePassword(auth.currentUser, p1); showToast("Password updated!", "success"); });

        document.getElementById('pageContentSelect').addEventListener('change', async (e) => { 
            const s = await get(ref(db, `pageContent/${e.target.value}`)); 
            if(s.exists()) {
                document.getElementById('pageContentText').value = s.val().text || '';
                document.getElementById('pageImageLink').value = s.val().image || '';
            } else {
                document.getElementById('pageContentText').value = '';
                document.getElementById('pageImageLink').value = '';
            }
        });

        DOM.logoutBtn.addEventListener('click', () => signOut(auth));
        DOM.loginBtn.addEventListener('click', () => { DOM.landingPage.style.display='none'; DOM.authSection.style.display='block'; });
        document.getElementById('backToLandingBtn').addEventListener('click', () => { DOM.authSection.style.display='none'; DOM.landingPage.style.display='flex'; });
        DOM.studentAccessBtn.addEventListener('click', () => { DOM.landingPage.style.display='none'; DOM.studentAccess.style.display='block'; });
        document.getElementById('backFromStudentAccessBtn').addEventListener('click', () => { DOM.studentAccess.style.display='none'; DOM.landingPage.style.display='flex'; });
        
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            const nav = document.getElementById('mobileNav'); const content = document.getElementById('mobileNavContent'); nav.classList.add('open');

            content.innerHTML = document.querySelector('.nav-desktop ul').innerHTML;
            

            const installBtn = content.querySelector('#installAppBtn');
            if(installBtn) {
                 if(deferredPrompt) installBtn.classList.add('mobile-visible');
                 else installBtn.style.display = 'none';


                 installBtn.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            deferredPrompt = null;
                            installBtn.style.display = 'none';
                            DOM.installAppBtn.style.display = 'none';
                        }
                    }
                 });
            }

            if(AppState.currentUser) {
                content.innerHTML += `<hr style="border:0; border-top:1px solid rgba(0,0,0,0.05); width:100%">`;
                if(AppState.isSystemAdmin) content.innerHTML += `<button onclick="document.getElementById('systemOverviewBtn').click(); document.getElementById('mobileNav').classList.remove('open')" class="btn btn-secondary" style="width:100%">Admin</button>`;
                content.innerHTML += `<button onclick="document.getElementById('publicFilesBtn').click(); document.getElementById('mobileNav').classList.remove('open')" class="btn btn-secondary" style="width:100%">Public Files</button>`;
                content.innerHTML += `<button onclick="document.getElementById('privateFilesBtn').click(); document.getElementById('mobileNav').classList.remove('open')" class="btn btn-secondary" style="width:100%">My Private Files</button>`;
                content.innerHTML += `<button onclick="document.getElementById('logoutBtn').click()" class="btn btn-danger" style="width:100%">Logout</button>`;
            }
        });
        document.getElementById('closeMobileNav').addEventListener('click', () => document.getElementById('mobileNav').classList.remove('open'));

        onAuthStateChanged(auth, updateUI);
        

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            DOM.installAppBtn.style.display = 'inline-flex';
        });

        DOM.installAppBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    DOM.installAppBtn.style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        window.addEventListener('load', async () => {
           if(typeof tsParticles !== 'undefined') {
                await tsParticles.load("tsparticles", { particles: { number: { value: 30 }, color: { value: "#4f46e5" }, opacity: { value: 0.1 }, size: { value: 2 }, move: { enable: true, speed: 0.5 } } });
           }
        });
    </script>
</body>
</html>

